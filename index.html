<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Magic Star - Share Your Wish</title>
    <!-- AI & CV Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .input_video { display: none; }

        /* å¯åŠ¨é®ç½©å±‚ */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; backdrop-filter: blur(10px);
            transition: opacity 0.8s;
        }
        #start-btn {
            margin-top: 30px; padding: 15px 50px; font-size: 18px;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border: none; border-radius: 50px; color: white; cursor: pointer;
            box-shadow: 0 0 25px rgba(0, 210, 255, 0.6);
            animation: pulse 2s infinite; font-weight: bold; letter-spacing: 1px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* çŠ¶æ€æç¤ºèƒ¶å›Š */
        #status-pill {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20;
            background: rgba(255,255,255,0.15); padding: 8px 24px; border-radius: 30px;
            backdrop-filter: blur(8px); color: #fff; font-size: 13px; letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.2); white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* --- å®šåˆ¶å™¨ UI --- */
        #maker-btn {
            position: fixed; bottom: 25px; right: 25px; z-index: 50;
            background: rgba(255,255,255,0.15); color: #fff; 
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px; border-radius: 30px; font-size: 13px; cursor: pointer;
            backdrop-filter: blur(10px); transition: all 0.3s;
        }
        #maker-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }

        #maker-panel {
            display: none; position: fixed; bottom: 80px; right: 20px; width: 300px;
            background: rgba(20, 20, 35, 0.95); border: 1px solid #444; border-radius: 16px;
            padding: 25px; z-index: 51; color: white; font-size: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        #maker-panel h3 { margin: 0 0 5px 0; color: #00d2ff; }
        #maker-panel input[type="text"] {
            width: 100%; padding: 12px; margin: 10px 0; background: #2a2a35; border: 1px solid #444;
            color: white; border-radius: 8px; box-sizing: border-box; outline: none;
        }
        #maker-panel input[type="text"]:focus { border-color: #00d2ff; }

        /* ç¾åŒ–æ–‡ä»¶ä¸Šä¼ æŒ‰é’® */
        .file-upload-label {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 12px; margin: 10px 0;
            background: #2a2a35; border: 1px dashed #666; border-radius: 8px;
            cursor: pointer; color: #aaa; box-sizing: border-box; transition: all 0.3s;
        }
        .file-upload-label:hover { border-color: #00d2ff; color: #fff; background: #333; }
        
        #gen-btn {
            width: 100%; background: linear-gradient(90deg, #00d2ff, #3a7bd5); 
            color: #fff; border: none; padding: 12px;
            border-radius: 8px; margin-top: 15px; cursor: pointer; font-weight: bold;
            transition: opacity 0.3s;
        }
        #gen-btn:disabled { opacity: 0.5; cursor: wait; }
        
        #close-maker { position: absolute; top: 15px; right: 20px; cursor: pointer; color: #888; font-size: 18px; }
        .tips { font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.4; }
        #loading-text { font-size: 12px; color: #00d2ff; display: none; text-align: center; margin-top: 5px;}
    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-overlay">
        <h1 style="font-weight: 300; letter-spacing: 4px; margin-bottom: 10px;">MAGIC STAR</h1>
        <p style="color: #bbb; font-size: 14px;">ä¸“å±æ˜Ÿç©ºç¤¼ç‰©</p>
        <button id="start-btn">å¼€å¯ä½“éªŒ</button>
        <div style="margin-top: 40px; color: #666; font-size: 12px; line-height: 2;">
            <div>ğŸ–ï¸ å¼ å¼€æ‰‹æŒ Â· å”¤é†’æ˜Ÿæ²³</div>
            <div>âœŠ æ¡ç´§æ‹³å¤´ Â· å‘ˆç°ç¥ç¦</div>
        </div>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤º -->
    <div id="status-pill">ç­‰å¾…å¯åŠ¨...</div>
    
    <video class="input_video" playsinline webkit-playsinline muted></video>
    <div id="canvas-container"></div>

    <!-- â­ï¸ å®šåˆ¶æŒ‰é’® -->
    <div id="maker-btn">âœ¨ æˆ‘ä¹Ÿè¦å®šåˆ¶</div>

    <!-- â­ï¸ å®šåˆ¶é¢æ¿ -->
    <div id="maker-panel">
        <div id="close-maker">âœ•</div>
        <h3>å®šåˆ¶ä½ çš„ç¤¼ç‰©</h3>
        <div class="tips">ä¸Šä¼ ä¸€å¼ ç…§ç‰‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸“å±é“¾æ¥ã€‚</div>
        
        <label>1. ç¥ç¦è¯­ (è‹±æ–‡æ˜¾ç¤ºæ•ˆæœæœ€ä½³):</label>
        <input type="text" id="custom-text" placeholder="ä¾‹å¦‚: HAPPY BIRTHDAY">
        
        <label>2. ä¸Šä¼ ç…§ç‰‡ (è‡ªåŠ¨ç”Ÿæˆ):</label>
        <label for="img-upload" class="file-upload-label" id="upload-label">
            ğŸ“· ç‚¹å‡»é€‰æ‹©ç…§ç‰‡
        </label>
        <input type="file" id="img-upload" accept="image/*" style="display: none;">
        
        <div id="loading-text">ğŸš€ æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...</div>
        <button id="gen-btn">ç”Ÿæˆå¹¶å¤åˆ¶é“¾æ¥ ğŸ“‹</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // âœ… å·²å¡«å…¥ä½ çš„ ImgBB API Key
        const IMGBB_KEY = '486b3dbcc415576a5112c1937d31f9b1'; 

        // --- å…¨å±€å˜é‡ ---
        const urlParams = new URLSearchParams(window.location.search);
        // å¦‚æœé“¾æ¥é‡Œæ²¡æœ‰å›¾ç‰‡ï¼Œå°è¯•åŠ è½½ä»“åº“é‡Œçš„é»˜è®¤å›¾
        const PHOTO_URL = urlParams.get('img') || './love.jpg'; 
        const WISH_TEXT = urlParams.get('text') || 'HAPPY DAY';

        let scene, camera, renderer, composer, particles, photoMesh;
        let particlesData = [];
        const PARTICLE_COUNT = 5500;
        let isFist = false;
        let time = 0;
        let uploadedImgUrl = ""; // æš‚å­˜ä¸Šä¼ åçš„å›¾ç‰‡URL

        // ================= UI & ä¸Šä¼ é€»è¾‘ =================

        const makerBtn = document.getElementById('maker-btn');
        const makerPanel = document.getElementById('maker-panel');
        const closeMaker = document.getElementById('close-maker');
        const genBtn = document.getElementById('gen-btn');
        const fileInput = document.getElementById('img-upload');
        const uploadLabel = document.getElementById('upload-label');
        const loadingText = document.getElementById('loading-text');

        makerBtn.onclick = () => makerPanel.style.display = 'block';
        closeMaker.onclick = () => makerPanel.style.display = 'none';

        // ç›‘å¬å›¾ç‰‡é€‰æ‹©
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // UI åˆ‡æ¢ä¸ºåŠ è½½çŠ¶æ€
            uploadLabel.innerHTML = "â³ ä¸Šä¼ ä¸­...";
            uploadLabel.style.borderColor = "#00d2ff";
            loadingText.style.display = "block";
            genBtn.disabled = true;
            genBtn.innerText = "æ­£åœ¨å¤„ç†...";

            const formData = new FormData();
            formData.append("image", file);

            try {
                // å‘é€è¯·æ±‚åˆ° ImgBB
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    uploadedImgUrl = result.data.url;
                    
                    // UI åˆ‡æ¢ä¸ºæˆåŠŸçŠ¶æ€
                    uploadLabel.innerHTML = "âœ… ç…§ç‰‡å·²å°±ç»ª";
                    uploadLabel.style.borderColor = "#00ff88";
                    uploadLabel.style.color = "#00ff88";
                    loadingText.style.display = "none";
                    genBtn.disabled = false;
                    genBtn.innerText = "ç”Ÿæˆå¹¶å¤åˆ¶é“¾æ¥ ğŸ“‹";
                } else {
                    throw new Error("API Error: " + (result.error ? result.error.message : "Unknown"));
                }
            } catch (err) {
                console.error(err);
                alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\n(æç¤º: å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜)");
                uploadLabel.innerHTML = "âŒ å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•";
                uploadLabel.style.color = "#ff3333";
                uploadLabel.style.borderColor = "#ff3333";
                loadingText.style.display = "none";
                genBtn.disabled = false;
                genBtn.innerText = "ç”Ÿæˆå¹¶å¤åˆ¶é“¾æ¥ ğŸ“‹";
            }
        });
        
        // ç”Ÿæˆé“¾æ¥æŒ‰é’®
        genBtn.onclick = () => {
            const txt = document.getElementById('custom-text').value.trim() || 'HAPPY DAY';
            
            // é€»è¾‘ï¼šå¦‚æœåˆšä¸Šä¼ äº†æ–°å›¾ï¼Œå°±ç”¨æ–°å›¾ï¼›å¦åˆ™å¦‚æœåŸæ¥å°±æœ‰å›¾(éé»˜è®¤)ï¼Œç”¨åŸæ¥çš„ï¼›å¦åˆ™ä¸å¸¦å›¾å‚æ•°
            let finalImg = uploadedImgUrl || (PHOTO_URL !== './love.jpg' ? PHOTO_URL : '');
            
            let newUrl = `${window.location.origin}${window.location.pathname}?text=${encodeURIComponent(txt)}`;
            if(finalImg) newUrl += `&img=${encodeURIComponent(finalImg)}`;
            
            navigator.clipboard.writeText(newUrl).then(() => {
                alert("ğŸ‰ é“¾æ¥å·²å¤åˆ¶æˆåŠŸï¼\n\nå‘é€ç»™æœ‹å‹ï¼Œä»–æ‰“å¼€å°±æ˜¯ä½ åˆšåˆšè®¾ç½®çš„å†…å®¹ï¼");
            }).catch(() => {
                prompt("è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä¸‹é¢çš„é“¾æ¥ï¼š", newUrl);
            });
        };

        // ================= 3D & AI æ ¸å¿ƒé€»è¾‘ =================

        document.getElementById('start-btn').addEventListener('click', async () => {
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('start-overlay').remove(), 1000);
            init3DEngine(); 
            loadPhoto(PHOTO_URL); // åŠ è½½ç…§ç‰‡
            await startCameraAI();
        });

        // åŠ è½½ç…§ç‰‡ (æ”¯æŒè·¨åŸŸ)
        function loadPhoto(url) {
            const loader = new THREE.TextureLoader();
            loader.setCrossOrigin('anonymous'); // å…³é”®ï¼šå…è®¸åŠ è½½å›¾åºŠå›¾ç‰‡
            
            loader.load(url, (tex) => {
                tex.colorSpace = THREE.SRGBColorSpace;
                const aspect = tex.image.width / tex.image.height;
                let w = 120, h = 120;
                if(aspect > 1) h = w / aspect; else w = h * aspect;
                
                const geo = new THREE.PlaneGeometry(w, h);
                const mat = new THREE.MeshBasicMaterial({
                    map: tex, side: THREE.DoubleSide, transparent: true,
                    color: new THREE.Color(0x999999) // å‹æš—é˜²è¿‡æ›
                });
                
                if(photoMesh) scene.remove(photoMesh);
                photoMesh = new THREE.Mesh(geo, mat);
                photoMesh.position.y = 20;
                scene.add(photoMesh);
            }, undefined, (err) => {
                console.log("å›¾ç‰‡åŠ è½½å¤±è´¥(å¯èƒ½æ˜¯é“¾æ¥å¤±æ•ˆæˆ–è·¨åŸŸé™åˆ¶)");
            });
        }

        function init3DEngine() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050510, 0.002); 

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 2000);
            camera.position.set(0, 0, 380);

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.6; bloomPass.strength = 0.6; bloomPass.radius = 0.5;
            
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 1.0;

            initParticles();
            calcNebulaTargets();
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // åˆ›å»ºé—ªçƒç²’å­è´´å›¾
        function createSparkleTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const ctx = c.getContext('2d');
            const grad = ctx.createRadialGradient(32,32,0,32,32,32);
            grad.addColorStop(0, 'white');
            grad.addColorStop(0.4, 'rgba(200,240,255,0.5)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad; ctx.fillRect(0,0,64,64);
            return new THREE.Texture(c);
        }

        function initParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = [], cols = [], sizes = [];
            const colors = [new THREE.Color('#ffffff'), new THREE.Color('#00ffff'), new THREE.Color('#ff00ff')];
            const tex = createSparkleTexture(); tex.needsUpdate = true;

            for(let i=0; i<PARTICLE_COUNT; i++) {
                pos.push((Math.random()-0.5)*600, (Math.random()-0.5)*600, (Math.random()-0.5)*600);
                const c = colors[Math.floor(Math.random()*colors.length)];
                cols.push(c.r, c.g, c.b);
                sizes.push(Math.random()*2 + 0.5);
                particlesData.push({ tx:0, ty:0, tz:0, speed: 0.02+Math.random()*0.03, rand: Math.random()*100 });
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            const mat = new THREE.PointsMaterial({
                size: 3.5, vertexColors: true, map: tex,
                blending: THREE.AdditiveBlending, depthWrite: false, transparent: true
            });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        function calcNebulaTargets() {
            for(let i=0; i<PARTICLE_COUNT; i++) {
                const r = 200 + Math.random()*200;
                const theta = Math.random()*Math.PI*2;
                const phi = Math.acos(2*Math.random()-1);
                particlesData[i].tx = r * Math.sin(phi) * Math.cos(theta);
                particlesData[i].ty = r * Math.sin(phi) * Math.sin(theta);
                particlesData[i].tz = r * Math.cos(phi);
            }
        }

        function calcTextTargets(text) {
            const c = document.createElement('canvas'); const ctx = c.getContext('2d');
            c.width = 1024; c.height = 512;
            ctx.font = "900 130px sans-serif"; ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(text, c.width/2, c.height/2);
            const data = ctx.getImageData(0,0,c.width,c.height).data;
            let valid = [];
            for(let y=0; y<c.height; y+=4) {
                for(let x=0; x<c.width; x+=4) {
                    if(data[(y*c.width+x)*4+3]>128) valid.push({x:(x-c.width/2)*0.8, y:-(y-c.height/2)*0.8});
                }
            }
            for(let i=0; i<PARTICLE_COUNT; i++) {
                if(i<valid.length) {
                    particlesData[i].tx = valid[i].x; particlesData[i].ty = valid[i].y; particlesData[i].tz = 0;
                } else {
                    const r = 300 + Math.random()*100; const ang = Math.random()*6.28;
                    particlesData[i].tx = Math.cos(ang)*r; particlesData[i].ty = (Math.random()-0.5)*400; particlesData[i].tz = Math.sin(ang)*r;
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            const pos = particles.geometry.attributes.position.array;
            const floatScale = isFist ? 0.3 : 4.0; 
            
            for(let i=0; i<PARTICLE_COUNT; i++) {
                const idx = i*3; const d = particlesData[i];
                pos[idx] += (d.tx + Math.sin(time+d.rand)*floatScale - pos[idx]) * d.speed;
                pos[idx+1] += (d.ty + Math.cos(time+d.rand)*floatScale - pos[idx+1]) * d.speed;
                pos[idx+2] += (d.tz - pos[idx+2]) * d.speed;
            }
            particles.geometry.attributes.position.needsUpdate = true;
            if(photoMesh) {
                photoMesh.visible = !isFist;
                if(photoMesh.visible) {
                    photoMesh.lookAt(camera.position);
                    photoMesh.position.y = 20 + Math.sin(time)*5;
                }
            }
            composer.render();
        }

        async function startCameraAI() {
            const status = document.getElementById('status-pill');
            const video = document.querySelector('.input_video');
            
            // é’ˆå¯¹æ‰‹æœºä¼˜åŒ–ï¼šå¼ºåˆ¶å‰ç½®ï¼Œé™ä½åˆ†è¾¨ç‡
            const constraints = {
                audio: false,
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
            };

            if(typeof Hands === 'undefined') { status.innerText = "AI åŠ è½½å¤±è´¥"; return; }

            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            
            hands.onResults(results => {
                if(results.multiHandLandmarks.length > 0) {
                    const marks = results.multiHandLandmarks[0];
                    const wrist = marks[0];
                    const tips = [marks[8], marks[12], marks[16], marks[20]];
                    let folded = 0;
                    // ç®€åŒ–ç‰ˆæ¡æ‹³æ£€æµ‹ï¼ˆè·ç¦»åˆ¤æ–­ï¼‰
                    tips.forEach(t => { if(Math.sqrt((t.x-wrist.x)**2+(t.y-wrist.y)**2) < 0.35) folded++; });
                    
                    const nowFist = folded >= 3;
                    if(nowFist !== isFist) {
                        isFist = nowFist;
                        if(isFist) {
                            status.innerText = "âœŠ æ”¶åˆ°ç¥ç¦";
                            calcTextTargets(WISH_TEXT);
                        } else {
                            status.innerText = "ğŸ–ï¸ æ˜Ÿæ²³çƒ‚æ¼«";
                            calcNebulaTargets();
                        }
                    }
                }
            });

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    const cam = new Camera(video, {
                        onFrame: async () => await hands.send({image: video}),
                        width: 640, height: 480
                    });
                    cam.start();
                    status.innerText = "âœ… è¯†åˆ«ä¸­ - è¯·å¯¹å‡†é•œå¤´";
                };
            } catch(e) {
                console.error(e);
                status.innerText = "æ— æ³•å¼€å¯æ‘„åƒå¤´";
            }
        }
    </script>
</body>
</html>
